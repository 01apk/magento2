<?xml version="1.0" encoding="UTF-8"?>
<!--
 /**
  * Copyright Â© Magento, Inc. All rights reserved.
  * See COPYING.txt for license details.
  */
-->

<tests xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:noNamespaceSchemaLocation="urn:magento:mftf:Test/etc/testSchema.xsd">
    <test name="CreateAnAdminOrderUsingBraintreePaymentTest1">
        <annotations>
            <features value="Backend"/>
            <stories value="Creation an admin order using Braintree payment"/>
            <title value="Create order using Braintree payment"/>
            <description value="Admin should be able to create order using Braintree payment"/>
            <severity value="CRITICAL"/>
            <testCaseId value="MAGETWO-93677"/>
            <group value="braintree"/>
        </annotations>


        <before>
            <!--Login As Admin-->
            <actionGroup ref="LoginAsAdmin" stepKey="loginAsAdmin"/>

            <!--CreateNewProduct-->
            <createData entity="_defaultCategory" stepKey="createCategory"/>
            <createData entity="_defaultProduct" stepKey="createProduct">
                <requiredEntity createDataKey="createCategory"/>
            </createData>

            <!--Create New Customer-->
            <createData stepKey="createCustomer" entity="Simple_US_Customer"/>
        </before>


        <!--Configure Braintree-->
        <actionGroup ref="ConfigureBraintree" stepKey="configureBraintree"/>

        <!--Create New Role-->
        <actionGroup ref="AdminCreateRoleActionGroup" stepKey="adminCreateRole">
            <argument name="restrictedRole" value="Sales"/>
            <argument name="User" value="adminRole"/>
        </actionGroup>

        <!--Create new admin user-->
        <actionGroup ref="AdminCreateUserActionGroup" stepKey="adminCreateUser">
            <argument name="role" value="adminRole"/>
        </actionGroup>

        <!--SignOut-->
        <actionGroup ref="logout" stepKey="signOutFromAdmin"/>

        <!--Log in as new user-->
        <actionGroup ref="LoginAsAnyUser" stepKey="LoginActionGroup">
            <argument name="uname" value="{{newAdmin.username}}"/>
            <argument name="passwd" value="{{newAdmin.password}}"/>
        </actionGroup>
        <waitForPageLoad stepKey="waitForLogin" time="3"/>

        <!--Create New Order-->
        <actionGroup ref="navigateToNewOrderPageExistingCustomer" stepKey="navigateToNewOrder">
            <argument name="customer" value="Simple_US_Customer"/>
        </actionGroup>

        <actionGroup ref="addSimpleProductToOrder" stepKey="addProduct">
            <argument name="product" value="_defaultProduct"/>
        </actionGroup>

        <actionGroup ref="fillOrderCustomerInformation" stepKey="fillCustomerAddress">
            <argument name="customer" value="Simple_US_Customer"/>
            <argument name="address" value="US_Address_TX"/>
        </actionGroup>

        <actionGroup ref="orderSelectFlatRateShipping" stepKey="selectFlatRateShipping"/>

        <waitForPageLoad stepKey="waitForShippingToFinish"/>

        <actionGroup ref="useBraintreeForMasterCard" stepKey="selectCardWithBraintree"/>

        <click stepKey="submitOrder" selector="{{NewOrderSection.submitOrder}}"/>
        <waitForPageLoad stepKey="waitForSaveConfig" time="5"/>
        <waitForElementVisible selector="{{NewOrderSection.successMessage}}" stepKey="waitForSuccessMessage" time="1"/>

        <after>
            <!-- Disable BrainTree -->
            <actionGroup ref="DisableBrainTree" stepKey="disableBrainTree"/>

            <!--SignOut-->
            <actionGroup ref="SignOut" stepKey="signOutFromNewUser"/>
            <actionGroup ref="LoginAsAdmin" stepKey="loginAsAdmin"/>

            <!--Delete Product-->
            <deleteData stepKey="deleteProduct" createDataKey="createProduct"/>

            <!--Delete Customer-->
            <deleteData stepKey="deleteCustomer" createDataKey="createCustomer"/>

            <!--Delete created user-->
            <actionGroup ref="AdminDeleteUserActionGroup" stepKey="AdminDeleteUserActionGroup">
                <argument name="user" value="adminRole"/>
            </actionGroup>

            <!--Delete created role-->
            <actionGroup ref="AdminDeleteCreatedRoleActionGroup" stepKey="AdminDeleteRoleActionGroup">
                <argument name="role" value="adminRole"/>
            </actionGroup>
        </after>
    </test>
</tests>
