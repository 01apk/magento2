<?xml version="1.0" encoding="UTF-8"?>
<!--
 /**
  * Copyright Â© Magento, Inc. All rights reserved.
  * See COPYING.txt for license details.
  */
-->

<tests xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:noNamespaceSchemaLocation="urn:magento:mftf:Test/etc/testSchema.xsd">
    <test name="AdminImportSimpleAndConfigurableProductsWithAssignedImagesTest">
        <annotations>
            <features value="Import/Export"/>
            <stories value="Import Products"/>
            <title value="Import Configurable Product With Simple Child Products With Images"/>
            <description value="Imports a .csv file containing a configurable product with 3 child simple products that
            have images. Verifies that products are imported successfully, that the images are attached to the
            products as expected, and that the configurable product can be purchased successfully."/>
            <severity value="MAJOR"/>
            <testCaseId value="MC-38222"/>
            <group value="importExport"/>
            <group value="ConfigurableProduct"/>
        </annotations>

        <before>
            <!-- Create Product Attribute with 3 Options -->
            <createData entity="ProductAttributeWithThreeOptionsForImport" stepKey="createImportProductAttribute"/>
            <createData entity="ProductAttributeOptionOneForExportImport" stepKey="createImportProductAttributeOption1">
                <requiredEntity createDataKey="createImportProductAttribute"/>
            </createData>
            <createData entity="ProductAttributeOptionTwoForExportImport" stepKey="createImportProductAttributeOption2">
                <requiredEntity createDataKey="createImportProductAttribute"/>
            </createData>
            <createData entity="ProductAttributeOptionThreeForImport" stepKey="createImportProductAttributeOption3">
                <requiredEntity createDataKey="createImportProductAttribute"/>
            </createData>
            <createData entity="AddToDefaultSet" stepKey="addToProductAttributeSet">
                <requiredEntity createDataKey="createImportProductAttribute"/>
            </createData>

            <!-- Create a Product & Attach a JPG & PNG -->
            <createData entity="ImportCategory_Configurable" stepKey="createImportCategory"/>
            <createData entity="_defaultCategory" stepKey="createCategory"/>
            <createData entity="ApiSimpleProduct" stepKey="productForImages">
                <requiredEntity createDataKey="createCategory"/>
            </createData>
            <createData entity="ApiProductAttributeMediaGalleryForExportImport" stepKey="productImage1">
                <requiredEntity createDataKey="productForImages"/>
            </createData>
            <createData entity="ApiProductAttributeMediaGalleryForExportImport2" stepKey="productImage2">
                <requiredEntity createDataKey="productForImages"/>
            </createData>
            <createData entity="ApiProductAttributeMediaGalleryForExportImport3" stepKey="productImage3">
                <requiredEntity createDataKey="productForImages"/>
            </createData>
            <createData entity="Simple_US_Customer" stepKey="createCustomer"/>

            <!-- Login as Admin -->
            <actionGroup ref="AdminLoginActionGroup" stepKey="loginAsAdmin"/>
        </before>

        <after>
            <!-- Delete Data -->
            <deleteData createDataKey="createImportCategory" stepKey="deleteImportCategory"/>
            <deleteData createDataKey="createCategory" stepKey="deleteCategory"/>
            <deleteData createDataKey="productForImages" stepKey="deleteProductForImages"/>
            <deleteData createDataKey="createCustomer" stepKey="deleteCustomer"/>
            <deleteData url="/V1/products/{{ImportProductSimple1_Configurable.urlKey}}" stepKey="deleteImportedSimpleProduct1"/>
            <deleteData url="/V1/products/{{ImportProductSimple2_Configurable.urlKey}}" stepKey="deleteImportedSimpleProduct2"/>
            <deleteData url="/V1/products/{{ImportProductSimple3_Configurable.urlKey}}" stepKey="deleteImportedSimpleProduct3"/>
            <deleteData url="/V1/products/{{ImportProduct_Configurable.urlKey}}" stepKey="deleteImportedConfigurableProduct"/>
            <deleteData createDataKey="createImportProductAttribute" stepKey="deleteProductAttribute"/>
            <actionGroup ref="NavigateToAndResetProductGridToDefaultViewActionGroup" stepKey="navigateToAndResetProductGridToDefaultView"/>
            <actionGroup ref="AdminLogoutActionGroup" stepKey="logoutFromAdmin"/>
        </after>

        <!-- Import Configurable Product with Simple Child Products & Assert No Errors -->
        <actionGroup ref="AdminNavigateToImportPageActionGroup" stepKey="navigateToImportPage"/>
        <actionGroup ref="AdminFillImportFormActionGroup" stepKey="fillImportForm">
            <argument name="importFile" value="{{ImportProduct_Configurable.fileName}}"/>
        </actionGroup>
        <actionGroup ref="AdminClickCheckDataImportActionGroup" stepKey="clickCheckData"/>
        <see selector="{{AdminImportValidationMessagesSection.success}}" userInput="{{ImportCommonMessages.validFile}}" stepKey="seeCheckDataResultMessage"/>
        <dontSeeElementInDOM selector="{{AdminImportValidationMessagesSection.importErrorList}}" stepKey="dontSeeErrorMessage"/>
        <actionGroup ref="AdminClickImportActionGroup" stepKey="clickImport"/>
        <see selector="{{AdminImportValidationMessagesSection.notice}}" userInput="{{ImportProduct_Configurable.importSummary}}" stepKey="seeNoticeMessage"/>
        <see selector="{{AdminImportValidationMessagesSection.messageByType('success')}}" userInput="{{ImportCommonMessages.success}}" stepKey="seeImportMessage"/>
        <dontSeeElementInDOM selector="{{AdminImportValidationMessagesSection.importErrorList}}" stepKey="dontSeeErrorMessage2"/>

        <!-- Reindex -->
        <actionGroup ref="CliIndexerReindexActionGroup" stepKey="reindex">
            <argument name="indices" value=""/>
        </actionGroup>

        <!-- Admin: Verify Data on Import History Page -->
        <actionGroup ref="AdminNavigateToImportHistoryPageActionGroup" stepKey="navigateToImportHistoryPage"/>
        <actionGroup ref="AdminGridSortColumnDescendingActionGroup" stepKey="sortColumnByIdDescending">
            <argument name="columnLabel" value="history_id"/>
        </actionGroup>
        <see userInput="{{ImportProduct_Configurable.fileName}}" selector="{{AdminDataGridTableSection.firstRow}}" stepKey="seeImportedFile"/>
        <see userInput="{{ImportProduct_Configurable.importSummary}}" selector="{{AdminDataGridTableSection.firstRow}}" stepKey="seeSummary"/>

        <!-- Admin: Verify Simple Product 1 on Edit Product Page -->
        <actionGroup ref="NavigateToCreatedProductEditPageActionGroup" stepKey="goToSimpleProduct1EditPage">
            <argument name="product" value="ImportProductSimple1_Configurable"/>
        </actionGroup>
        <actionGroup ref="AdminAssertProductInfoOnEditPageActionGroup" stepKey="assertSimpleProduct1OnEditPage">
            <argument name="productStatus" value="{{ImportProductSimple1_Configurable.status}}"/>
            <argument name="productName" value="{{ImportProductSimple1_Configurable.name}}"/>
            <argument name="productSku" value="{{ImportProductSimple1_Configurable.sku}}"/>
            <argument name="productPrice" value="{{ImportProductSimple1_Configurable.price}}"/>
            <argument name="productQuantity" value="{{ImportProductSimple1_Configurable.quantity}}"/>
            <argument name="productWeight" value="{{ImportProductSimple1_Configurable.weight}}"/>
            <argument name="productVisibility" value="{{ImportProductSimple1_Configurable.visibilityText}}"/>
            <argument name="categoryNames" value="{{ImportCategory_Configurable.name}}"/>
        </actionGroup>
        <actionGroup ref="AssertProductImageAdminProductPageActionGroup" stepKey="assertProduct1ImageOnEditPage">
            <argument name="image" value="MagentoLogo"/>
        </actionGroup>

        <!-- Admin: Verify Simple Product 2 on Edit Product Page -->
        <actionGroup ref="NavigateToCreatedProductEditPageActionGroup" stepKey="goToSimpleProduct2EditPage">
            <argument name="product" value="ImportProductSimple2_Configurable"/>
        </actionGroup>
        <actionGroup ref="AdminAssertProductInfoOnEditPageActionGroup" stepKey="assertSimpleProduct2OnEditPage">
            <argument name="productStatus" value="{{ImportProductSimple2_Configurable.status}}"/>
            <argument name="productName" value="{{ImportProductSimple2_Configurable.name}}"/>
            <argument name="productSku" value="{{ImportProductSimple2_Configurable.sku}}"/>
            <argument name="productPrice" value="{{ImportProductSimple2_Configurable.price}}"/>
            <argument name="productQuantity" value="{{ImportProductSimple2_Configurable.quantity}}"/>
            <argument name="productWeight" value="{{ImportProductSimple2_Configurable.weight}}"/>
            <argument name="productVisibility" value="{{ImportProductSimple1_Configurable.visibilityText}}"/>
            <argument name="categoryNames" value="{{ImportCategory_Configurable.name}}"/>
        </actionGroup>
        <actionGroup ref="AssertProductImageAdminProductPageActionGroup" stepKey="assertProduct2ImageOnEditPage">
            <argument name="image" value="TestImage"/>
        </actionGroup>

        <!-- Admin: Verify Simple Product 3 on Edit Product Page -->
        <actionGroup ref="NavigateToCreatedProductEditPageActionGroup" stepKey="goToSimpleProduct3EditPage">
            <argument name="product" value="ImportProductSimple3_Configurable"/>
        </actionGroup>
        <actionGroup ref="AdminAssertProductInfoOnEditPageActionGroup" stepKey="assertSimpleProduct3OnEditPage">
            <argument name="productStatus" value="{{ImportProductSimple3_Configurable.status}}"/>
            <argument name="productName" value="{{ImportProductSimple3_Configurable.name}}"/>
            <argument name="productSku" value="{{ImportProductSimple3_Configurable.sku}}"/>
            <argument name="productPrice" value="{{ImportProductSimple3_Configurable.price}}"/>
            <argument name="productQuantity" value="{{ImportProductSimple3_Configurable.quantity}}"/>
            <argument name="productWeight" value="{{ImportProductSimple3_Configurable.weight}}"/>
            <argument name="productVisibility" value="{{ImportProductSimple1_Configurable.visibilityText}}"/>
            <argument name="categoryNames" value="{{ImportCategory_Configurable.name}}"/>
        </actionGroup>
        <actionGroup ref="AssertProductImageAdminProductPageActionGroup" stepKey="assertProduct3ImageOnEditPage">
            <argument name="image" value="TestImageAdobe"/>
        </actionGroup>

        <!-- Admin: Verify Configurable Product Common Data on Edit Product Page -->
        <actionGroup ref="NavigateToCreatedProductEditPageActionGroup" stepKey="goToConfigurableProductEditPage">
            <argument name="product" value="ImportProduct_Configurable"/>
        </actionGroup>
        <actionGroup ref="AdminAssertProductInfoOnEditPageActionGroup" stepKey="assertConfigurableProductOnEditPage">
            <argument name="productStatus" value="{{ImportProduct_Configurable.status}}"/>
            <argument name="productName" value="{{ImportProduct_Configurable.name}}"/>
            <argument name="productSku" value="{{ImportProduct_Configurable.sku}}"/>
            <argument name="productPrice" value="{{ImportProduct_Configurable.price}}"/>
            <argument name="productQuantity" value="{{ImportProduct_Configurable.quantity}}"/>
            <argument name="productWeight" value="{{ImportProduct_Configurable.weight}}"/>
            <argument name="productVisibility" value="{{ImportProduct_Configurable.visibilityText}}"/>
            <argument name="categoryNames" value="{{ImportCategory_Configurable.name}}"/>
        </actionGroup>
        <actionGroup ref="AssertProductImageAdminProductPageActionGroup" stepKey="assertConfigurableProductBaseImageOnEditPage">
            <argument name="image" value="TestImageAdobe"/>
        </actionGroup>
        <seeElement selector="{{AdminProductImagesSection.imageFileRoleByImage(TestImageAdobe.filename, 'image')}}" stepKey="seeBaseImageRoleConfigurable"/>
        <actionGroup ref="AssertProductImageAdminProductPageActionGroup" stepKey="assertConfigurableProductSmallImageOnEditPage">
            <argument name="image" value="TestImageAdobe"/>
        </actionGroup>
        <seeElement selector="{{AdminProductImagesSection.imageFileRoleByImage(TestImageAdobe.filename, 'small_image')}}" stepKey="seeSmallImageRoleConfigurable"/>
        <actionGroup ref="AssertProductImageAdminProductPageActionGroup" stepKey="assertConfigurableProductThumbnailImageOnEditPage">
            <argument name="image" value="TestImageAdobe"/>
        </actionGroup>
        <seeElement selector="{{AdminProductImagesSection.imageFileRoleByImage(TestImageAdobe.filename, 'thumbnail')}}" stepKey="seeThumbnailImageRoleConfigurable"/>

        <!-- Admin: Verify Configurable Product Information on Edit Product Page -->
        <seeNumberOfElements userInput="3" selector="{{AdminProductFormConfigurationsSection.currentVariationsAllRows}}" stepKey="see3RowsAdmin"/>
        <actionGroup ref="AdminVerifyCurrentVariationsForConfigurableProductActionGroup" stepKey="verifyConfigurableChildProduct1Admin">
            <argument name="image" value="{{ImportProductSimple1_Configurable.thumbnailImage}}"/>
            <argument name="name" value="{{ImportProductSimple1_Configurable.name}}"/>
            <argument name="sku" value="{{ImportProductSimple1_Configurable.sku}}"/>
            <argument name="price" value="${{ImportProductSimple1_Configurable.price}}"/>
            <argument name="quantity" value="{{ImportProductSimple1_Configurable.quantity}}"/>
            <argument name="weight" value="{{ImportProductSimple1_Configurable.weight}}"/>
            <argument name="status" value="{{ImportProductSimple1_Configurable.statusText}}"/>
            <argument name="attributes" value="{{ProductAttributeWithThreeOptionsForImport.attribute_code}}: {{ProductAttributeOptionOneForExportImport.label}}"/>
            <argument name="index" value="1"/>
        </actionGroup>
        <actionGroup ref="AdminVerifyCurrentVariationsForConfigurableProductActionGroup" stepKey="verifyConfigurableChildProduct2Admin">
            <argument name="image" value="{{ImportProductSimple2_Configurable.thumbnailImage}}"/>
            <argument name="name" value="{{ImportProductSimple2_Configurable.name}}"/>
            <argument name="sku" value="{{ImportProductSimple2_Configurable.sku}}"/>
            <argument name="price" value="${{ImportProductSimple2_Configurable.price}}"/>
            <argument name="quantity" value="{{ImportProductSimple2_Configurable.quantity}}"/>
            <argument name="weight" value="{{ImportProductSimple2_Configurable.weight}}"/>
            <argument name="status" value="{{ImportProductSimple2_Configurable.statusText}}"/>
            <argument name="attributes" value="{{ProductAttributeWithThreeOptionsForImport.attribute_code}}: {{ProductAttributeOptionTwoForExportImport.label}}"/>
            <argument name="index" value="2"/>
        </actionGroup>
        <actionGroup ref="AdminVerifyCurrentVariationsForConfigurableProductActionGroup" stepKey="verifyConfigurableChildProduct3Admin">
            <argument name="image" value="{{ImportProductSimple3_Configurable.thumbnailImage}}"/>
            <argument name="name" value="{{ImportProductSimple3_Configurable.name}}"/>
            <argument name="sku" value="{{ImportProductSimple3_Configurable.sku}}"/>
            <argument name="price" value="${{ImportProductSimple3_Configurable.price}}"/>
            <argument name="quantity" value="{{ImportProductSimple3_Configurable.quantity}}"/>
            <argument name="weight" value="{{ImportProductSimple3_Configurable.weight}}"/>
            <argument name="status" value="{{ImportProductSimple3_Configurable.statusText}}"/>
            <argument name="attributes" value="{{ProductAttributeWithThreeOptionsForImport.attribute_code}}: {{ProductAttributeOptionThreeForImport.label}}"/>
            <argument name="index" value="3"/>
        </actionGroup>

        <!-- Storefront: Verify Configurable Product In Category -->
        <actionGroup ref="LoginToStorefrontActionGroup" stepKey="loginStorefront">
            <argument name="Customer" value="$$createCustomer$$"/>
        </actionGroup>
        <actionGroup ref="StorefrontNavigateToCategoryUrlActionGroup" stepKey="goToCategoryPage">
            <argument name="categoryUrl" value="{{ImportCategory_Configurable.name_lwr}}"/>
        </actionGroup>
        <seeNumberOfElements selector="{{StorefrontCategoryMainSection.productName}}" userInput="1" stepKey="seeOnly1Product"/>
        <see userInput="{{ImportProduct_Configurable.name}}" selector="{{StorefrontCategoryMainSection.productName}}" stepKey="seeConfigurableProduct"/>
        <dontSee userInput="{{ImportProductSimple1_Configurable.name}}" selector="{{StorefrontCategoryMainSection.productsList}}" stepKey="dontSeeSimpleProduct1"/>
        <dontSee userInput="{{ImportProductSimple2_Configurable.name}}" selector="{{StorefrontCategoryMainSection.productsList}}" stepKey="dontSeeSimpleProduct2"/>
        <dontSee userInput="{{ImportProductSimple3_Configurable.name}}" selector="{{StorefrontCategoryMainSection.productsList}}" stepKey="dontSeeSimpleProduct3"/>

        <!-- Storefront: Verify Configurable Product Info & Image -->
        <actionGroup ref="StorefrontOpenProductPageActionGroup" stepKey="openProductStorefrontPage">
            <argument name="productUrl" value="{{ImportProduct_Configurable.urlKey}}"/>
        </actionGroup>
        <see selector="{{StorefrontProductInfoMainSection.productName}}" userInput="{{ImportProduct_Configurable.name}}" stepKey="seeProductName"/>
        <see selector="{{StorefrontProductInfoMainSection.productSku}}" userInput="{{ImportProduct_Configurable.sku}}" stepKey="seeSku"/>
        <see selector="{{StorefrontProductInfoMainSection.productPrice}}" userInput="As low as ${{ImportProductSimple1_Configurable.price}}" stepKey="seePrice"/>
        <seeElement selector="{{StorefrontProductInfoMainSection.productImageSrc(TestImageAdobe.filename)}}" stepKey="seeTestImageAdobe"/>

        <!-- Storefront: Verify Configurable Product Option 1 Info & Image -->
        <actionGroup ref="StorefrontProductPageSelectDropDownOptionValueActionGroup" stepKey="selectOption1">
            <argument name="attributeLabel" value="{{ProductAttributeFrontendLabelImport1.label}}"/>
            <argument name="optionLabel" value="{{ProductAttributeOptionOneForExportImport.label}}"/>
        </actionGroup>
        <see selector="{{StorefrontProductInfoMainSection.productName}}" userInput="{{ImportProduct_Configurable.name}}" stepKey="seeProductName2"/>
        <see selector="{{StorefrontProductInfoMainSection.productSku}}" userInput="{{ImportProduct_Configurable.sku}}" stepKey="seeSku2"/>
        <see selector="{{StorefrontProductInfoMainSection.productPrice}}" userInput="${{ImportProductSimple1_Configurable.price}}" stepKey="seePrice2"/>
        <seeElement selector="{{StorefrontProductInfoMainSection.productImageSrc(MagentoLogo.filename)}}" stepKey="seeMagentoLogoImage"/>

        <!-- Storefront: Verify Configurable Product Option 2 Info & Image -->
        <actionGroup ref="StorefrontProductPageSelectDropDownOptionValueActionGroup" stepKey="selectOption2">
            <argument name="attributeLabel" value="{{ProductAttributeFrontendLabelImport1.label}}"/>
            <argument name="optionLabel" value="{{ProductAttributeOptionTwoForExportImport.label}}"/>
        </actionGroup>
        <see selector="{{StorefrontProductInfoMainSection.productName}}" userInput="{{ImportProduct_Configurable.name}}" stepKey="seeProductName3"/>
        <see selector="{{StorefrontProductInfoMainSection.productSku}}" userInput="{{ImportProduct_Configurable.sku}}" stepKey="seeSku3"/>
        <see selector="{{StorefrontProductInfoMainSection.productPrice}}" userInput="${{ImportProductSimple2_Configurable.price}}" stepKey="seePrice3"/>
        <seeElement selector="{{StorefrontProductInfoMainSection.productImageSrc(TestImage.filename)}}" stepKey="seeTestImage"/>

        <!-- Storefront: Verify Configurable Product Option 3 Info & Image -->
        <actionGroup ref="StorefrontProductPageSelectDropDownOptionValueActionGroup" stepKey="selectOption3">
            <argument name="attributeLabel" value="{{ProductAttributeFrontendLabelImport1.label}}"/>
            <argument name="optionLabel" value="{{ProductAttributeOptionThreeForImport.label}}"/>
        </actionGroup>
        <see selector="{{StorefrontProductInfoMainSection.productName}}" userInput="{{ImportProduct_Configurable.name}}" stepKey="seeProductName4"/>
        <see selector="{{StorefrontProductInfoMainSection.productSku}}" userInput="{{ImportProduct_Configurable.sku}}" stepKey="seeSku4"/>
        <see selector="{{StorefrontProductInfoMainSection.productPrice}}" userInput="${{ImportProductSimple3_Configurable.price}}" stepKey="seePrice4"/>
        <seeElement selector="{{StorefrontProductInfoMainSection.productImageSrc(TestImageAdobe.filename)}}" stepKey="seeTestImageAdobe2"/>

        <!-- Purchase Configurable Product -->
        <actionGroup ref="StorefrontAddToTheCartActionGroup" stepKey="addProductToCart"/>
        <actionGroup ref="StorefrontOpenCheckoutPageActionGroup" stepKey="navigateToCheckoutPage"/>
        <actionGroup ref="StorefrontSetShippingMethodActionGroup" stepKey="selectFlatRateShippingMethod"/>
        <actionGroup ref="StorefrontCheckoutClickNextOnShippingStepActionGroup" stepKey="clickNextOnShippingStep"/>
        <actionGroup ref="CheckoutSelectCheckMoneyOrderPaymentActionGroup" stepKey="selectCheckMoneyOrder"/>
        <actionGroup ref="ClickPlaceOrderActionGroup" stepKey="clickPlacePurchaseOrder"/>
        <grabTextFrom selector="{{CheckoutSuccessMainSection.orderNumber22}}" stepKey="grabOrderNumber"/>

        <!-- Confirm Purchased Configurable Product -->
        <actionGroup ref="StorefrontOpenOrderFromSuccessPageActionGroup" stepKey="openOrderFromSuccessPage">
            <argument name="orderNumber" value="{$grabOrderNumber}"/>
        </actionGroup>
        <seeNumberOfElements selector="{{StorefrontCustomerOrderViewSection.productRows}}" userInput="1" stepKey="seeOnly1ProductInOrder"/>
        <actionGroup ref="StorefrontVerifyCustomerOrderProductRowDataActionGroup" stepKey="verifyProductRowInOrder">
            <argument name="name" value="{{ImportProduct_Configurable.name}}"/>
            <argument name="sku" value="{{ImportProductSimple3_Configurable.sku}}"/>
            <argument name="price" value="${{ImportProductSimple3_Configurable.price}}"/>
            <argument name="quantity" value="1"/>
            <argument name="subtotal" value="${{ImportProductSimple3_Configurable.price}}"/>
        </actionGroup>
        <waitForText userInput="{{ProductAttributeWithThreeOptionsForImport.attribute_code}}" selector="{{StorefrontCustomerOrderViewSection.productNameByRow('1')}}" stepKey="seeProductAttribute"/>
        <waitForText userInput="{{ProductAttributeOptionThreeForImport.label}}" selector="{{StorefrontCustomerOrderViewSection.productNameByRow('1')}}" stepKey="seeProductAttributeOption"/>
    </test>
</tests>
