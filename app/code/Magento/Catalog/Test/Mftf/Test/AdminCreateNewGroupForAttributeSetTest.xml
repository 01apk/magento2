<?xml version="1.0" encoding="UTF-8"?>
<!--
 /**
  * Copyright Â© Magento, Inc. All rights reserved.
  * See COPYING.txt for license details.
  */
-->

<tests xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:noNamespaceSchemaLocation="urn:magento:mftf:Test/etc/testSchema.xsd">
    <test name="AdminCreateNewGroupForAttributeSetTest">
        <annotations>
            <stories value="Edit attribute set"/>
            <title value="Admin should be able to create new group in an Attribute Set"/>
            <description value="The test verifies creating a new group in an attribute set and a validation message in case of empty group name"/>
            <severity value="CRITICAL"/>
            <testCaseId value="MC-170"/>
            <group value="Catalog"/>
        </annotations>
        <before>
        <!-- Create a custom attribute set and custom product attribute -->
        <createData entity="CatalogAttributeSet" stepKey="createAttributeSet"/>
        <createData entity="productAttributeWithTwoOptions" stepKey="createConfigProductAttribute"/>
        </before>
        <after>
            <deleteData createDataKey="createConfigProductAttribute" stepKey="deleteConfigProductAttribute"/>
            <actionGroup ref="logout" stepKey="logout"/>
        </after>
        <!-- Login to Admin -->
        <actionGroup ref="LoginAsAdmin" stepKey="LoginAsAdmin"/>
        
        <!-- Navigate to Stores > Attributes > Attribute Set -->
        <amOnPage url="{{AdminProductAttributeSetGridPage.url}}" stepKey="goToAttributeSetPage"/>
        <waitForPageLoad stepKey="waitForPageLoad"/>

        <!-- Search and open Attribute Set from preconditions -->
        <actionGroup ref="goToAttributeSetByName" stepKey="searchAttribute">
            <argument name="name" value="$$createAttributeSet.attribute_set_name$$"/>
        </actionGroup>

        <!-- Click 'Add New': Show 'New Group' Modal -->
        <click selector="{{AdminProductAttributeSetEditSection.AddNewGroup}}" stepKey="clickAddNew"/>
        <waitForAjaxLoad stepKey="waitForAjax"/>

        <!-- Fill 'name' for new group and click 'Ok': Name = <empty> -->
        <fillField userInput="" selector="{{AdminProductAttributeSetEditSection.newGroupName}}" stepKey="fillName"/>
        <click selector="{{AdminProductAttributeSetEditSection.buttonOk}}" stepKey="clickOk"/>

        <!-- Error message 'This is a required field.' is displayed -->
        <see userInput="This is a required field." selector="{{AdminProductAttributeSetEditSection.errorLabel}}" stepKey="seeErrorMessage"/>

        <!-- Fill 'name' for new group and click 'Ok': Name = Custom group -->
        <fillField userInput="Custom group" selector="{{AdminProductAttributeSetEditSection.newGroupName}}" stepKey="fillCustomGroupName"/>
        <click selector="{{AdminProductAttributeSetEditSection.buttonOk}}" stepKey="clickButtonOk"/>

        <!-- Group is created and displayed in 'Groups' block -->
        <seeElement selector="{{AdminProductAttributeSetEditSection.attributeGroup('Custom group')}}" stepKey="assertCustomGroup"/>

        <!-- Move custom Product Attribute to new 'Custom group' Group -->
        <waitForAjaxLoad stepKey="waitForAjaxLoad"/>
        <click selector="{{AdminProductAttributeSetEditSection.attributeGroupExtender('Custom group')}}" stepKey="click"/>
        <waitForPageLoad stepKey="waitForPageLoadAfterClick"/>
        <dragAndDrop selector1="{{AdminProductAttributeSetEditSection.unassignedAttribute($$createConfigProductAttribute.attribute_code$$)}}" selector2="{{AdminProductAttributeSetEditSection.attributeGroupExtender('Custom group')}}" stepKey="moveAttribute"/>
        <waitForPageLoad stepKey="waitForDragAndDrop"/>

        <!-- Attribute is displayed in the new group -->
        <see userInput="$$createConfigProductAttribute.attribute_code$$" selector="{{AdminProductAttributeSetEditSection.groupTree}}" stepKey="seeAttribute"/>

        <!-- Click 'Save' -->
        <actionGroup ref="SaveAttributeSet" stepKey="saveAttribute"/>

        <actionGroup ref="goToAttributeSetByName" stepKey="backTohAttributeSet">
            <argument name="name" value="$$createAttributeSet.attribute_set_name$$"/>
        </actionGroup>

        <!-- Create another group: Name = Empty group -->
        <click selector="{{AdminProductAttributeSetEditSection.AddNewGroup}}" stepKey="clickAddEmptyGroup"/>
        <waitForAjaxLoad stepKey="waitForLoad"/>

        <fillField userInput="Empty group" selector="{{AdminProductAttributeSetEditSection.newGroupName}}" stepKey="fillGroupName"/>
        <click selector="{{AdminProductAttributeSetEditSection.buttonOk}}" stepKey="clickOnOk"/>
        <waitForPageLoad stepKey="waitForNewGroup"/>

        <!-- Empty group is created. No attributes are assigned to it. -->
        <seeElement selector="{{AdminProductAttributeSetEditSection.attributeGroup('Empty group')}}" stepKey="assertEmptyGroup"/>
        <dontSeeElement selector="{{AdminProductAttributeSetEditSection.attributesInGroup('Empty group')}}" stepKey="seeNoAttributes"/>
      
        <!-- Navigate to Catalog > Products -->
        <amOnPage url="{{AdminProductIndexPage.url}}" stepKey="amOnProductPage"/>
        <waitForPageLoad stepKey="waitForProductPageLoad"/>

        <!-- Start to create a new simple product with the custom attribute set from the preconditions -->
        <click selector="{{AdminProductGridActionSection.addProductBtn}}" stepKey="clickAddProduct"/>
        <waitForPageLoad stepKey="waitForNewProductPage"/>
        
        <actionGroup ref="AdminProductPageSelectAttributeSet" stepKey="selectAttribute">
            <argument name="attributeSetName" value="$$createAttributeSet.attribute_set_name$$"/>
        </actionGroup>

        <!-- New Section 'Custom group' is present in form. The section contains the attribute from preconditions  -->
        <seeElement selector="{{AdminProductAttributeSection.attributeGroupByName('Custom group')}}" stepKey="seeSectionCustomGroup"/>
        <click selector="{{AdminProductAttributeSection.attributeGroupByName('Custom group')}}" stepKey="openCustomGroupSection"/>
        <waitForAjaxLoad stepKey="waitForOpenSection"/>
        <scrollTo selector="//footer" stepKey="scrollToFooter"/>
        <seeElement selector="{{AdminProductAttributeSection.attributeByGroupAndName('Custom group')}}" stepKey="seeAttributePresent"/>

        <!-- Empty section is absent in Product Form -->
        <dontSeeElement selector="{{AdminProductAttributeSection.attributeGroupByName('Empty group')}}" stepKey="dontSeeEmptyGroup"/>
    </test>
</tests>
