<?xml version="1.0" encoding="UTF-8"?>
<!--
 /**
  * Copyright Â© Magento, Inc. All rights reserved.
  * See COPYING.txt for license details.
  */
-->

<tests xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:noNamespaceSchemaLocation="urn:magento:mftf:Test/etc/testSchema.xsd">
    <test name="AdminCartPriceRuleForAutoTypeUsesPerCouponTest">
        <annotations>
            <features value="SalesRule"/>
            <stories value="Create cart price rule"/>
            <title value="Customer cannot use a distinct coupon code from the same Cart Price Rule."/>
            <description value="Customer cannot use a distinct coupon code from the same Cart Price Rule."/>
            <severity value="CRITICAL"/>
            <testCaseId value="AC-7872"/>
            <useCaseId value="ACP2E-1551"/>
            <group value="SalesRule"/>
        </annotations>

        <before>
            <!-- Create Customer with filled Shipping & Billing Address -->
            <createData entity="CustomerEntityOne" stepKey="createCustomer"/>
            <!--Create simple product-->
            <createData entity="SimpleProduct2" stepKey="createSimpleProduct"/>

            <actionGroup ref="AdminLoginActionGroup" stepKey="loginAsAdmin"/>
        </before>

        <after>
            <!--Delete simple product created during the test-->
            <deleteData createDataKey="createSimpleProduct" stepKey="deleteSimpleProduct"/>
            <!-- Delete the cart price rule we made during the test -->
            <actionGroup ref="DeleteCartPriceRuleByName" stepKey="cleanUpRule">
                <argument name="ruleName" value="{{_defaultCoupon.code}}"/>
            </actionGroup>
            <!--Delete customer created during test-->
            <deleteData createDataKey="createCustomer" stepKey="deleteCustomer"/>

            <actionGroup ref="AdminLogoutActionGroup" stepKey="adminLogout"/>
        </after>

        <!-- Create a cart price rule  -->
        <actionGroup ref="AdminOpenCartPriceRulesPageActionGroup" stepKey="amOnCartPriceList"/>
        <click selector="{{AdminCartPriceRulesSection.addNewRuleButton}}" stepKey="clickAddNewRule"/>
        <fillField selector="{{AdminCartPriceRulesFormSection.ruleName}}" userInput="{{_defaultCoupon.code}}" stepKey="fillRuleName"/>
        <selectOption selector="{{AdminCartPriceRulesFormSection.websites}}" userInput="Main Website" stepKey="selectWebsites"/>
        <!-- Select custom customer groups -->
        <click selector="{{CartPriceRuleSection.customerGroupsToggle}}" stepKey="clickCustomerGroupsToggle" after="selectWebsites"/>
        <click selector="{{CartPriceRuleSection.selectAll}}" stepKey="clickSelectAll" after="clickCustomerGroupsToggle"/>
        <click selector="{{CartPriceRuleSection.doneButton}}" stepKey="clickDoneButton" after="clickSelectAll"/>
        <!-- Choose coupon type auto -->
        <selectOption selector="{{AdminCartPriceRulesFormSection.coupon}}" userInput="Auto" stepKey="selectCouponType"/>
        <!-- Verify `Use Auto Generation` checkbox not visible while `Uses per Coupon` field there for coupon type auto-->
        <dontSeeCheckboxIsChecked selector="{{AdminCartPriceRulesFormSection.useAutoGeneration}}" stepKey="tickAutoGeneration"/>
        <fillField selector="{{AdminCartPriceRulesFormSection.userPerCoupon}}" userInput="1" stepKey="fillUsesPerCoupon"/>
        <!--Open Actions tabs, fill required field and save the cart price rule-->
        <click selector="{{AdminCartPriceRulesFormSection.actionsHeader}}" stepKey="clickToExpandActions"/>
        <selectOption selector="{{AdminCartPriceRulesFormSection.apply}}" userInput="{{CatPriceRule.apply}}" stepKey="selectActionType"/>
        <fillField selector="{{AdminCartPriceRulesFormSection.discountAmount}}" userInput="{{CatPriceRule.discountAmount}}" stepKey="fillDiscountAmount"/>
        <click selector="{{AdminCartPriceRulesFormSection.saveAndContinue}}" stepKey="clickSaveAndContinueButton"/>
        <see selector="{{AdminCartPriceRulesSection.messages}}" userInput="You saved the rule." stepKey="seeRuleSavedSuccessMessage"/>
        <waitForPageLoad stepKey="waitForPageToLoad"/>

        <!-- Generate some coupon codes -->
        <click selector="{{AdminCartPriceRulesFormSection.manageCouponCodesHeader}}" stepKey="expandCouponSection"/>
        <fillField selector="{{AdminCartPriceRulesFormSection.couponQty}}" userInput="5" stepKey="fillCouponQty"/>
        <click selector="{{AdminCartPriceRulesFormSection.generateCouponsButton}}" stepKey="clickGenerate"/>
        <see selector="{{AdminCartPriceRulesFormSection.successMessage}}" userInput="Message is added to queue, wait to get your coupons soon" stepKey="seeGenerationSuccess"/>

        <!--Start coupon code generator queue-->
        <actionGroup ref="CliConsumerStartActionGroup" stepKey="startMessageQueue">
            <argument name="consumerName" value="{{AdminCodeGeneratorMessageConsumerData.consumerName}}"/>
            <argument name="maxMessages" value="1"/>
        </actionGroup>

        <!--Reload cart price rule page-->
        <actionGroup ref="ReloadPageActionGroup" stepKey="refreshPage"/>

        <!--Open Manage Coupon Codes tab again to see generated coupon codes-->
        <click selector="{{AdminCartPriceRulesFormSection.manageCouponCodesHeader}}" stepKey="expandCouponSectionSecondTime"/>
        <scrollTo selector="{{AdminCartPriceRulesFormSection.couponGridUsedHeader}}" stepKey="scrollToCouponGridUsedHeader"/>
        <waitForElementVisible selector="{{AdminCartPriceRulesFormSection.couponGridUsedHeader}}"  stepKey="waitForNewRule"/>

        <!--Assert coupon codes grid header is correct -->
        <see selector="{{AdminCartPriceRulesFormSection.couponGridUsedHeader}}" userInput="Used" stepKey="seeCorrectUsedHeader"/>

        <!--Grab two coupon codes and hold on to it for later use -->
        <grabTextFrom selector="{{AdminCartPriceRulesFormSection.generatedCouponByIndex('1')}}" stepKey="couponCode"/>
        <grabTextFrom selector="{{AdminCartPriceRulesFormSection.generatedCouponByIndex('2')}}" stepKey="couponCode2"/>

        <!-- Login with created Customer -->
        <actionGroup ref="LoginToStorefrontActionGroup" stepKey="loginAsCustomer">
            <argument name="Customer" value="$$createCustomer$$"/>
        </actionGroup>

        <!--Open the Product Page, add the product to Cart, go to Shopping Cart and Apply the first coupon code -->
        <amOnPage url="{{StorefrontProductPage.url($$createSimpleProduct.custom_attributes[url_key]$$)}}" stepKey="openProductPage"/>
        <actionGroup ref="ApplyCartRuleOnStorefrontActionGroup" stepKey="applyCartPriceRule">
            <argument name="product" value="$$createSimpleProduct$$"/>
            <argument name="couponCode" value="{$couponCode}"/>
        </actionGroup>
        <waitForText userInput='You used coupon code "{$couponCode}"' stepKey="waitForText"/>
        <see selector="{{StorefrontMessagesSection.success}}" userInput='You used coupon code "{$couponCode}"' stepKey="seeSuccessMessage"/>
        <waitForElementVisible selector="{{CheckoutCartSummarySection.discountAmount}}" time="30" stepKey="waitForElementDiscountVisible"/>

        <!-- Go to Checkout and Click Place Order button -->
        <actionGroup ref="StorefrontClickProceedToCheckoutActionGroup" stepKey="clickProceedToCheckout"/>
        <click selector="{{CheckoutShippingMethodsSection.checkShippingMethodByName('Flat Rate')}}"
               stepKey="selectFlatShippingMethod"/>
        <waitForLoadingMaskToDisappear stepKey="waitForLoadingMask"/>
        <actionGroup ref="StorefrontCheckoutClickNextButtonActionGroup" stepKey="clickNext"/>
        <!-- Checkout select Check/Money Order payment -->
        <actionGroup ref="CheckoutSelectCheckMoneyOrderPaymentActionGroup" stepKey="selectCheckMoneyPayment"/>
        <actionGroup ref="ClickPlaceOrderActionGroup" stepKey="clickPlaceOrder"/>

        <!-- Start the usage processing consumer -->
        <actionGroup ref="CliConsumerStartActionGroup" stepKey="startUsageProcessingMessageQueue1">
            <argument name="consumerName" value="{{SalesRuleConsumerData.consumerName}}"/>
            <argument name="maxMessages" value="{{SalesRuleConsumerData.messageLimit}}"/>
        </actionGroup>

        <!-- Open the Product Page again, add the product to Cart, go to Shopping Cart and Apply the second coupon code -->
        <amOnPage url="{{StorefrontProductPage.url($$createSimpleProduct.custom_attributes[url_key]$$)}}" stepKey="openProductPage2"/>
        <waitForPageLoad stepKey="waitForPageLoad2"/>
        <actionGroup ref="ApplyCartRuleOnStorefrontActionGroup" stepKey="applyCartPriceRule2">
            <argument name="product" value="$$createSimpleProduct$$"/>
            <argument name="couponCode" value="{$couponCode2}"/>
        </actionGroup>
        <waitForText userInput='You used coupon code "{$couponCode2}"' stepKey="waitForText2"/>
        <see selector="{{StorefrontMessagesSection.success}}" userInput='You used coupon code "{$couponCode2}"' stepKey="seeSuccessMessage2"/>
        <waitForElementVisible selector="{{CheckoutCartSummarySection.discountAmount}}" time="30" stepKey="waitForElementDiscountVisible2"/>
    </test>
</tests>
