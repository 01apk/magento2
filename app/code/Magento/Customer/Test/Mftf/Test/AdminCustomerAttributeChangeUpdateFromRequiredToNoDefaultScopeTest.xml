<?xml version="1.0" encoding="UTF-8"?>
<!--
 /**
  * Copyright Â© Magento, Inc. All rights reserved.
  * See COPYING.txt for license details.
  */
-->

<tests xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:noNamespaceSchemaLocation="urn:magento:mftf:Test/etc/testSchema.xsd">
    <test name="AdminCustomerAttributeChangeUpdateFromRequiredToNoDefaultScopeTest">
        <annotations>
            <features value="Customer"/>
            <stories value="Customer attribute change from required to no"/>
            <title value="Admin should be able to save customer after changing attributes from required to no"/>
            <description value="Admin should be able to save customer after changing attributes from required to no in default scope"/>
            <severity value="CRITICAL"/>
            <testCaseId value="AC-6748"/>
            <group value="customer"/>
        </annotations>
        <before>
            <!-- Login to admin -->
            <actionGroup ref="AdminLoginActionGroup" stepKey="LoginAsAdmin"/>
            <!-- Create a customer -->
            <createData entity="Simple_US_Customer" stepKey="createCustomer"/>
        </before>
        <after>
            <!-- Navigate to customer configuration page -->
            <actionGroup ref="AdminNavigateToCustomerConfigurationActionGroup" stepKey="gotoCustomerConfiguration"/>
            <!-- Expand "Name and Address Option" section -->
            <actionGroup ref="AdminExpandConfigSectionActionGroup" stepKey="expandConfigSectionDefaultScope">
                <argument name="sectionName" value="{{CustomerConfigurationSectionNameAndAddressOptions.title}}"/>
            </actionGroup>

            <!-- Set "Show Date of Birth" to Required and save in default config scope -->
            <actionGroup ref="AdminCheckUseSystemValueActionGroup" stepKey="checkUseSystemValue">
                <argument name="rowId" value="row_customer_address_dob_show"/>
            </actionGroup>
            <click selector="{{StoreConfigSection.Save}}" stepKey="saveConfig"/>

            <!-- Delete customer -->
            <deleteData createDataKey="createCustomer" stepKey="deleteCustomer"/>

            <!-- Logout from admin -->
            <actionGroup ref="AdminLogoutActionGroup" stepKey="logout"/>
        </after>
        <!-- Navigate to customer configuration page -->
        <actionGroup ref="AdminNavigateToCustomerConfigurationActionGroup" stepKey="gotoCustomerConfiguration"/>
        <!-- Expand "Name and Address Option" section -->
        <actionGroup ref="AdminExpandConfigSectionActionGroup" stepKey="expandConfigSectionDefaultScope">
            <argument name="sectionName" value="{{CustomerConfigurationSectionNameAndAddressOptions.title}}"/>
        </actionGroup>
        <!-- Set "Show Date of Birth" to Required and save in default config scope -->
        <actionGroup ref="AdminCustomerShowDateOfBirthActionGroup" stepKey="setShowDateOfBirthRequiredDefaultScope">
            <argument name="value" value="{{ShowDateOfBirth.required}}"/>
        </actionGroup>

        <!-- Open the customer edit page -->
        <actionGroup ref="AdminOpenCustomerEditPageActionGroup" stepKey="goToCustomerEditPage">
            <argument name="customerId" value="$createCustomer.id$"/>
        </actionGroup>
        <!-- Switch the information tab -->
        <actionGroup ref="AdminOpenAccountInformationTabFromCustomerEditPageActionGroup" stepKey="openInformationTab"/>
        <!-- Fill the dob -->
        <fillField userInput="{{CustomerEntityOne.dob}}" selector="{{AdminCustomerAccountInformationSection.dateOfBirth}}" stepKey="fillDateOfBirth"/>
        <!-- Assert that the address is successfully added -->
        <actionGroup stepKey="saveAndContinue" ref="AdminCustomerSaveAndContinue"/>

        <!-- Navigate to customer configuration page -->
        <actionGroup ref="AdminNavigateToCustomerConfigurationActionGroup" stepKey="gotoCustomerConfigurationAgain"/>
        <!-- Expand "Name and Address Option" section -->
        <actionGroup ref="AdminExpandConfigSectionActionGroup" stepKey="expandConfigSectionDefaultScopeAgain">
            <argument name="sectionName" value="{{CustomerConfigurationSectionNameAndAddressOptions.title}}"/>
        </actionGroup>
        <!-- Set "Show Date of Birth" to Required and save in default config scope -->
        <actionGroup ref="AdminCheckUseSystemValueActionGroup" stepKey="checkUseSystemValue">
            <argument name="rowId" value="row_customer_address_dob_show"/>
        </actionGroup>
        <click selector="{{StoreConfigSection.Save}}" stepKey="saveConfig"/>
        <!-- Open the customer edit page -->
        <actionGroup ref="AdminOpenCustomerEditPageActionGroup" stepKey="goToCustomerEditPageAgain">
            <argument name="customerId" value="$createCustomer.id$"/>
        </actionGroup>
        <!-- Switch the information tab -->
        <actionGroup ref="AdminOpenAccountInformationTabFromCustomerEditPageActionGroup" stepKey="openInformationTabAgain"/>
        <!-- Fill the dob -->
        <fillField userInput="" selector="{{AdminCustomerAccountInformationSection.dateOfBirth}}" stepKey="fillDateOfBirthAgain"/>
        <!-- Assert that the address is successfully added -->
        <actionGroup stepKey="saveAndContinueAgain" ref="AdminCustomerSaveAndContinue"/>
    </test>
</tests>
