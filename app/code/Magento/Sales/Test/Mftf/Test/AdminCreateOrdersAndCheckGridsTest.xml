<?xml version="1.0" encoding="UTF-8"?>
<!--
 /**
  * Copyright Â© Magento, Inc. All rights reserved.
  * See COPYING.txt for license details.
  */
-->
<tests xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="urn:magento:mftf:Test/etc/testSchema.xsd">
    <test name="AdminCreateOrdersAndCheckGridsTest">
        <annotations>
            <stories value="Create orders and check grids"/>
            <title value="Create orders, invoices, shipments and credit memos and check grids"/>
            <description value="Create orders, invoices, shipments and credit memos and check async grids"/>
            <severity value="AVERAGE"/>
            <useCaseId value="ACP2E-1367" />
            <testCaseId value="AC-7106" />
            <group value="sales"/>
        </annotations>
        <before>
            <magentoCLI command="config:set dev/grid/async_indexing 1" stepKey="enableAsyncIndexing"/>
            <magentoCLI command="cache:clean config" stepKey="cacheCleanBefore"/>

            <actionGroup ref="AdminLoginActionGroup" stepKey="LoginAsAdmin"/>

            <createData entity="ApiCategory" stepKey="createCategory"/>

            <createData entity="defaultSimpleProduct" stepKey="createSimpleProduct">
                <requiredEntity createDataKey="createCategory"/>
            </createData>

            <createData entity="GuestCart" stepKey="createGuestCartOne"/>
            <createData entity="SimpleCartItem" stepKey="addCartItemOne">
                <requiredEntity createDataKey="createGuestCartOne"/>
                <requiredEntity createDataKey="createSimpleProduct"/>
            </createData>
            <createData entity="GuestAddressInformation" stepKey="addGuestOrderAddressOne">
                <requiredEntity createDataKey="createGuestCartOne"/>
            </createData>
            <updateData createDataKey="createGuestCartOne" entity="GuestOrderPaymentMethod" stepKey="sendGuestPaymentInformationOne">
                <requiredEntity createDataKey="createGuestCartOne"/>
            </updateData>

            <magentoCLI command="cron:run" stepKey="runCronOne"/>

            <createData entity="Invoice" stepKey="invoiceOrderOne">
                <requiredEntity createDataKey="createGuestCartOne"/>
            </createData>

            <createData entity="GuestCart" stepKey="createGuestCartTwo"/>
            <createData entity="SimpleCartItem" stepKey="addCartItemTwo">
                <requiredEntity createDataKey="createGuestCartTwo"/>
                <requiredEntity createDataKey="createSimpleProduct"/>
            </createData>
            <createData entity="GuestAddressInformation" stepKey="addGuestOrderAddressTwo">
                <requiredEntity createDataKey="createGuestCartTwo"/>
            </createData>
            <updateData createDataKey="createGuestCartTwo" entity="GuestOrderPaymentMethod" stepKey="sendGuestPaymentInformationTwo">
                <requiredEntity createDataKey="createGuestCartTwo"/>
            </updateData>

            <createData entity="Shipment" stepKey="shipOrderOne">
                <requiredEntity createDataKey="createGuestCartOne"/>
            </createData>

            <magentoCLI command="cron:run" stepKey="runCronTwo"/>

            <createData entity="GuestCart" stepKey="createGuestCartThree"/>
            <createData entity="SimpleCartItem" stepKey="addCartItemThree">
                <requiredEntity createDataKey="createGuestCartThree"/>
                <requiredEntity createDataKey="createSimpleProduct"/>
            </createData>
            <createData entity="GuestAddressInformation" stepKey="addGuestOrderAddressThree">
                <requiredEntity createDataKey="createGuestCartThree"/>
            </createData>
            <updateData createDataKey="createGuestCartThree" entity="GuestOrderPaymentMethod" stepKey="sendGuestPaymentInformationThree">
                <requiredEntity createDataKey="createGuestCartThree"/>
            </updateData>

            <createData entity="CreditMemo" stepKey="refundOrderOne">
                <requiredEntity createDataKey="createGuestCartOne"/>
            </createData>

            <createData entity="Invoice" stepKey="invoiceOrderThree">
                <requiredEntity createDataKey="createGuestCartThree"/>
            </createData>

            <createData entity="Shipment" stepKey="shipOrderTwo">
                <requiredEntity createDataKey="createGuestCartTwo"/>
            </createData>

            <magentoCLI command="cron:run" stepKey="runCronThree"/>

            <createData entity="Invoice" stepKey="invoiceOrderTwo">
                <requiredEntity createDataKey="createGuestCartTwo"/>
            </createData>

            <createData entity="Shipment" stepKey="shipOrderThree">
                <requiredEntity createDataKey="createGuestCartThree"/>
            </createData>

            <createData entity="CreditMemo" stepKey="refundOrderTwo">
                <requiredEntity createDataKey="createGuestCartTwo"/>
            </createData>

            <magentoCLI command="cron:run" stepKey="runCronFour"/>

            <createData entity="CreditMemo" stepKey="refundOrderThree">
                <requiredEntity createDataKey="createGuestCartThree"/>
            </createData>

            <magentoCLI command="cron:run" stepKey="runCronFive"/>

        </before>

        <after>
            <magentoCLI command="config:set dev/grid/async_indexing 0" stepKey="enableAsyncIndexing"/>
            <magentoCLI command="cache:clean config" stepKey="cacheCleanAfter"/>
            <deleteData createDataKey="createCategory" stepKey="deleteCategory"/>
            <deleteData createDataKey="createSimpleProduct" stepKey="deleteProduct"/>
            <actionGroup ref="AdminLogoutActionGroup" stepKey="logout"/>
        </after>

        <actionGroup ref="AdminOrdersPageOpenActionGroup" stepKey="onOrderPage"/>
        <waitForPageLoad time="60" stepKey="waitForGrid"/>
        <actionGroup ref="AdminOrdersGridClearFiltersActionGroup" stepKey="clearFilters"/>

        <grabTextFrom selector="{{AdminOrdersGridSection.orderIdByIncrementId($createGuestCartOne.return$)}}" stepKey="getOrderOneId"/>
        <grabTextFrom selector="{{AdminOrdersGridSection.orderIdByIncrementId($createGuestCartTwo.return$)}}" stepKey="getOrderTwoId"/>
        <grabTextFrom selector="{{AdminOrdersGridSection.orderIdByIncrementId($createGuestCartThree.return$)}}" stepKey="getOrderThreeId"/>

        <actionGroup ref="AdminOpenOrderByEntityIdActionGroup" stepKey="openOrderOne">
            <argument name="entityId" value="$createGuestCartOne.return$"/>
        </actionGroup>

        <actionGroup ref="AdminOpenInvoiceTabFromOrderPageActionGroup" stepKey="openInvoicesTabOrdersPageOne"/>
        <waitForLoadingMaskToDisappear stepKey="waitForInvoiceGridLoadingMask1" after="openInvoicesTabOrdersPageOne"/>
        <see selector="{{AdminOrderInvoicesTabSection.gridRow('1')}}" stepKey="seeOrderInvoiceInTabGridOne" />
        <actionGroup ref="AdminOpenShipmentFromOrderPageActionGroup" stepKey="openShipmentsTabOrdersPageOne"/>
        <waitForLoadingMaskToDisappear stepKey="waitForShipmentGridLoadingMask2" after="openShipmentsTabOrdersPageOne"/>
        <see selector="{{AdminOrderShipmentsTabSection.gridRow('1')}}" stepKey="seeOrderShipmentInTabGridOne" />
        <actionGroup ref="AdminOpenCreditMemoFromOrderPageActionGroup" stepKey="openCreditMemosTabOrdersPageOne"/>
        <waitForLoadingMaskToDisappear stepKey="waitForCreditMemoGridLoadingMask3" after="openCreditMemosTabOrdersPageOne"/>
        <see selector="{{AdminOrderCreditMemosTabSection.gridRow('1')}}" stepKey="seeOrderCreditMemoInTabGridOne" />

        <actionGroup ref="AdminOpenOrderByEntityIdActionGroup" stepKey="openOrderTwo">
            <argument name="entityId" value="$createGuestCartTwo.return$"/>
        </actionGroup>

        <actionGroup ref="AdminOpenInvoiceTabFromOrderPageActionGroup" stepKey="openInvoicesTabOrdersPageTwo"/>
        <waitForLoadingMaskToDisappear stepKey="waitForInvoiceGridLoadingMask4" after="openInvoicesTabOrdersPageTwo"/>
        <see selector="{{AdminOrderInvoicesTabSection.gridRow('1')}}" stepKey="seeOrderInvoiceInTabGridTwo" />
        <actionGroup ref="AdminOpenShipmentFromOrderPageActionGroup" stepKey="openShipmentsTabOrdersPageTwo"/>
        <waitForLoadingMaskToDisappear stepKey="waitForShipmentGridLoadingMask5" after="openShipmentsTabOrdersPageTwo"/>
        <see selector="{{AdminOrderShipmentsTabSection.gridRow('1')}}" stepKey="seeOrderShipmentInTabGridTwo" />
        <actionGroup ref="AdminOpenCreditMemoFromOrderPageActionGroup" stepKey="openCreditMemosTabOrdersPageTwo"/>
        <waitForLoadingMaskToDisappear stepKey="waitForCreditMemoGridLoadingMask6" after="openCreditMemosTabOrdersPageTwo"/>
        <see selector="{{AdminOrderCreditMemosTabSection.gridRow('1')}}" stepKey="seeOrderCreditMemoInTabGridTwo" />

        <actionGroup ref="AdminOpenOrderByEntityIdActionGroup" stepKey="openOrderThree">
            <argument name="entityId" value="$createGuestCartThree.return$"/>
        </actionGroup>

        <actionGroup ref="AdminOpenInvoiceTabFromOrderPageActionGroup" stepKey="openInvoicesTabOrdersPageThree"/>
        <waitForLoadingMaskToDisappear stepKey="waitForInvoiceGridLoadingMask7" after="openInvoicesTabOrdersPageThree"/>
        <see selector="{{AdminOrderInvoicesTabSection.gridRow('1')}}" stepKey="seeOrderInvoiceInTabGridThree" />
        <actionGroup ref="AdminOpenShipmentFromOrderPageActionGroup" stepKey="openShipmentsTabOrdersPageThree"/>
        <waitForLoadingMaskToDisappear stepKey="waitForShipmentGridLoadingMask8" after="openShipmentsTabOrdersPageThree"/>
        <see selector="{{AdminOrderShipmentsTabSection.gridRow('1')}}" stepKey="seeOrderShipmentInTabGridThree" />
        <actionGroup ref="AdminOpenCreditMemoFromOrderPageActionGroup" stepKey="openCreditMemosTabOrdersPageThree"/>
        <waitForLoadingMaskToDisappear stepKey="waitForCreditMemoGridLoadingMask9" after="openCreditMemosTabOrdersPageThree"/>
        <see selector="{{AdminOrderCreditMemosTabSection.gridRow('1')}}" stepKey="seeOrderCreditMemoInTabGridThree" />
    </test>
</tests>
