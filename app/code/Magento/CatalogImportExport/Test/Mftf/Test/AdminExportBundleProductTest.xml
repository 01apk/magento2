<?xml version="1.0" encoding="UTF-8"?>
<!--
 /**
  * Copyright Â© Magento, Inc. All rights reserved.
  * See COPYING.txt for license details.
  */
-->

<tests xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:noNamespaceSchemaLocation="urn:magento:mftf:Test/etc/testSchema.xsd">
    <test name="AdminExportBundleProductTest">
        <annotations>
            <features value="CatalogImportExport"/>
            <stories value="Export Products"/>
            <title value="Export Bundle Products"/>
            <description value="Verifies that a user can export Bundle and Simple child products for Bundled products
            with a dynamic price, a fixed price, and a custom attribute. Verifies that the exported file and the
            downloadable copy of the exported file contain the expected products. Note that MFTF cannot simply download
            a file and have access to it due to the test not having access to the server that is running the test
            browser. Therefore, this test verifies that the Download button can be successfully clicked, grabs the
            request URL from the Download button, executes the request on the magento machine via a curl request, and
            verifies the contents of the downloaded file."/>
            <severity value="CRITICAL"/>
            <testCaseId value="MC-14008"/>
            <group value="catalog_import_export"/>
            <group value="mtf_migrated"/>
        </annotations>

        <before>
            <!--Create bundle product with dynamic price with two simple products -->
            <createData entity="SimpleProduct2" stepKey="firstSimpleProductForDynamic"/>
            <createData entity="SimpleProduct2" stepKey="secondSimpleProductForDynamic"/>
            <createData entity="ApiBundleProduct" stepKey="createDynamicBundleProduct"/>
            <createData entity="DropDownBundleOption" stepKey="createFirstBundleOption">
                <requiredEntity createDataKey="createDynamicBundleProduct"/>
            </createData>
            <createData entity="ApiBundleLink" stepKey="firstLinkOptionToDynamicProduct">
                <requiredEntity createDataKey="createDynamicBundleProduct"/>
                <requiredEntity createDataKey="createFirstBundleOption"/>
                <requiredEntity createDataKey="firstSimpleProductForDynamic"/>
            </createData>
            <createData entity="ApiBundleLink" stepKey="secondLinkOptionToDynamicProduct">
                <requiredEntity createDataKey="createDynamicBundleProduct"/>
                <requiredEntity createDataKey="createFirstBundleOption"/>
                <requiredEntity createDataKey="secondSimpleProductForDynamic"/>
            </createData>

            <!-- Create bundle product with fixed price with two simple products -->
            <createData entity="SimpleProduct2" stepKey="firstSimpleProductForFixed"/>
            <createData entity="SimpleProduct2" stepKey="secondSimpleProductForFixed"/>
            <createData entity="ApiFixedBundleProduct" stepKey="createFixedBundleProduct"/>
            <createData entity="DropDownBundleOption" stepKey="createSecondBundleOption">
                <requiredEntity createDataKey="createFixedBundleProduct"/>
            </createData>
            <createData entity="ApiBundleLink" stepKey="firstLinkOptionToFixedProduct">
                <requiredEntity createDataKey="createFixedBundleProduct"/>
                <requiredEntity createDataKey="createSecondBundleOption"/>
                <requiredEntity createDataKey="firstSimpleProductForFixed"/>
            </createData>
            <createData entity="ApiBundleLink" stepKey="secondLinkOptionToFixedProduct">
                <requiredEntity createDataKey="createFixedBundleProduct"/>
                <requiredEntity createDataKey="createSecondBundleOption"/>
                <requiredEntity createDataKey="secondSimpleProductForFixed"/>
            </createData>

            <!-- Create bundle product with custom textarea attribute with two simple products -->
            <createData entity="productAttributeWysiwyg" stepKey="createProductAttribute"/>
            <createData entity="AddToDefaultSet" stepKey="addToDefaultAttributeSet">
                <requiredEntity createDataKey="createProductAttribute"/>
            </createData>
            <createData entity="ApiFixedBundleProduct" stepKey="createFixedBundleProductWithAttribute">
                <requiredEntity createDataKey="addToDefaultAttributeSet"/>
            </createData>
            <createData entity="SimpleProduct2" stepKey="firstSimpleProductForFixedWithAttribute"/>
            <createData entity="SimpleProduct2" stepKey="secondSimpleProductForFixedWithAttribute"/>
            <createData entity="DropDownBundleOption" stepKey="createBundleOptionWithAttribute">
                <requiredEntity createDataKey="createFixedBundleProductWithAttribute"/>
            </createData>
            <createData entity="ApiBundleLink" stepKey="firstLinkOptionToFixedProductWithAttribute">
                <requiredEntity createDataKey="createFixedBundleProductWithAttribute"/>
                <requiredEntity createDataKey="createBundleOptionWithAttribute"/>
                <requiredEntity createDataKey="firstSimpleProductForFixedWithAttribute"/>
            </createData>
            <createData entity="ApiBundleLink" stepKey="secondLinkOptionToFixedProductWithAttribute">
                <requiredEntity createDataKey="createFixedBundleProductWithAttribute"/>
                <requiredEntity createDataKey="createBundleOptionWithAttribute"/>
                <requiredEntity createDataKey="secondSimpleProductForFixedWithAttribute"/>
            </createData>
            <actionGroup ref="AdminLoginActionGroup" stepKey="loginAsAdmin"/>
        </before>

        <after>
            <!-- Delete Data & Reindex -->
            <deleteData createDataKey="createDynamicBundleProduct" stepKey="deleteDynamicBundleProduct"/>
            <deleteData createDataKey="firstSimpleProductForDynamic" stepKey="deleteFirstSimpleProductForDynamic"/>
            <deleteData createDataKey="secondSimpleProductForDynamic" stepKey="deleteSecondSimpleProductForDynamic"/>
            <deleteData createDataKey="createFixedBundleProduct" stepKey="deleteFixedBundleProduct"/>
            <deleteData createDataKey="firstSimpleProductForFixed" stepKey="deleteFirstSimpleProductForFixed"/>
            <deleteData createDataKey="secondSimpleProductForFixed" stepKey="deleteSecondSimpleProductForFixed"/>
            <deleteData createDataKey="createFixedBundleProductWithAttribute" stepKey="deleteFixedBundleProductWithAttribute"/>
            <deleteData createDataKey="firstSimpleProductForFixedWithAttribute" stepKey="deleteFirstSimpleProductForFixedWithAttribute"/>
            <deleteData createDataKey="secondSimpleProductForFixedWithAttribute" stepKey="deleteSecondSimpleProductForFixedWithAttribute"/>
            <deleteData createDataKey="createProductAttribute" stepKey="deleteProductAttribute"/>
            <helper class="\Magento\Catalog\Test\Mftf\Helper\LocalFileAssertions" method="deleteDirectory" stepKey="deleteExportFileDirectory">
                <argument name="path">var/export</argument>
            </helper>
            <magentoCron groups="index" stepKey="reindexInvalidatedIndices"/>
            <actionGroup ref="AdminLogoutActionGroup" stepKey="logout"/>
        </after>

        <!-- Export Created Products -->
        <actionGroup ref="AdminNavigateToExportPageActionGroup" stepKey="goToExportIndexPage"/>
        <actionGroup ref="ExportAllProductsActionGroup" stepKey="exportCreatedProducts"/>

        <!-- Start Message Queue for Export Consumer -->
        <actionGroup ref="CliConsumerStartActionGroup" stepKey="startMessageQueue">
            <argument name="consumerName" value="{{AdminExportMessageConsumerData.consumerName}}"/>
            <argument name="maxMessages" value="{{AdminExportMessageConsumerData.messageLimit}}"/>
        </actionGroup>
        <reloadPage stepKey="refreshPage"/>
        <waitForPageLoad stepKey="waitForReload"/>
        <waitForElementVisible selector="{{AdminExportAttributeSection.exportFileNameByPosition('0')}}" stepKey="waitForFileName"/>
        <grabTextFrom selector="{{AdminExportAttributeSection.exportFileNameByPosition('0')}}" stepKey="grabNameFile"/>

        <!-- Validate Export File on File System -->
        <helper class="Magento\Catalog\Test\Mftf\Helper\LocalFileAssertions" method="assertFileExists" stepKey="assertExportFileExists">
            <argument name="filePath">var/export/{$grabNameFile}</argument>
        </helper>
        <helper class="Magento\Catalog\Test\Mftf\Helper\LocalFileAssertions" method="assertFileContainsString" stepKey="assertExportFileContainsFirstSimpleProductForDynamic">
            <argument name="filePath">var/export/{$grabNameFile}</argument>
            <argument name="text">$$firstSimpleProductForDynamic.sku$$</argument>
        </helper>
        <helper class="Magento\Catalog\Test\Mftf\Helper\LocalFileAssertions" method="assertFileContainsString" stepKey="assertExportFileContainsSecondSimpleProductForDynamic">
            <argument name="filePath">var/export/{$grabNameFile}</argument>
            <argument name="text">$$secondSimpleProductForDynamic.sku$$</argument>
        </helper>
        <helper class="Magento\Catalog\Test\Mftf\Helper\LocalFileAssertions" method="assertFileContainsString" stepKey="assertExportFileContainsDynamicBundleProduct">
            <argument name="filePath">var/export/{$grabNameFile}</argument>
            <argument name="text">$$createDynamicBundleProduct.sku$$</argument>
        </helper>
        <helper class="Magento\Catalog\Test\Mftf\Helper\LocalFileAssertions" method="assertFileContainsString" stepKey="assertExportFileContainsFirstSimpleProductForFixed">
            <argument name="filePath">var/export/{$grabNameFile}</argument>
            <argument name="text">$$firstSimpleProductForFixed.sku$$</argument>
        </helper>
        <helper class="Magento\Catalog\Test\Mftf\Helper\LocalFileAssertions" method="assertFileContainsString" stepKey="assertExportFileContainsSecondSimpleProductForFixed">
            <argument name="filePath">var/export/{$grabNameFile}</argument>
            <argument name="text">$$secondSimpleProductForFixed.sku$$</argument>
        </helper>
        <helper class="Magento\Catalog\Test\Mftf\Helper\LocalFileAssertions" method="assertFileContainsString" stepKey="assertExportFileContainsFixedBundleProduct">
            <argument name="filePath">var/export/{$grabNameFile}</argument>
            <argument name="text">$$createFixedBundleProduct.sku$$</argument>
        </helper>
        <helper class="Magento\Catalog\Test\Mftf\Helper\LocalFileAssertions" method="assertFileContainsString" stepKey="assertExportFileContainsFirstSimpleProductForFixedWithAttribute">
            <argument name="filePath">var/export/{$grabNameFile}</argument>
            <argument name="text">$$firstSimpleProductForFixedWithAttribute.sku$$</argument>
        </helper>
        <helper class="Magento\Catalog\Test\Mftf\Helper\LocalFileAssertions" method="assertFileContainsString" stepKey="assertExportFileContainsSecondSimpleProductForFixedWithAttribute">
            <argument name="filePath">var/export/{$grabNameFile}</argument>
            <argument name="text">$$secondSimpleProductForFixedWithAttribute.sku$$</argument>
        </helper>
        <helper class="Magento\Catalog\Test\Mftf\Helper\LocalFileAssertions" method="assertFileContainsString" stepKey="assertExportFileContainsFixedBundleProductWithAttribute">
            <argument name="filePath">var/export/{$grabNameFile}</argument>
            <argument name="text">$$createFixedBundleProductWithAttribute.sku$$</argument>
        </helper>

        <!-- Download Export File -->
        <actionGroup ref="DownloadFileActionGroup" stepKey="downloadCreatedProducts">
            <argument name="fileName" value="{$grabNameFile}"/>
        </actionGroup>

        <!-- Validate Downloaded Export File -->
        <grabAttributeFrom userInput="href" selector="{{AdminExportAttributeSection.download('0')}}" stepKey="grabExportUrl"/>
        <helper class="\Magento\Backend\Test\Mftf\Helper\CurlHelpers" method="assertCurlResponseContainsString" stepKey="assertDownloadFileContainsFirstSimpleProductForDynamic">
            <argument name="url">{$grabExportUrl}</argument>
            <argument name="expectedString">$$firstSimpleProductForDynamic.sku$$</argument>
        </helper>
        <helper class="\Magento\Backend\Test\Mftf\Helper\CurlHelpers" method="assertCurlResponseContainsString" stepKey="assertDownloadFileContainsSecondSimpleProductForDynamic">
            <argument name="url">{$grabExportUrl}</argument>
            <argument name="expectedString">$$secondSimpleProductForDynamic.sku$$</argument>
        </helper>
        <helper class="\Magento\Backend\Test\Mftf\Helper\CurlHelpers" method="assertCurlResponseContainsString" stepKey="assertDownloadFileContainsDynamicBundleProduct">
            <argument name="url">{$grabExportUrl}</argument>
            <argument name="expectedString">$$createDynamicBundleProduct.sku$$</argument>
        </helper>
        <helper class="\Magento\Backend\Test\Mftf\Helper\CurlHelpers" method="assertCurlResponseContainsString" stepKey="assertDownloadFileContainsFirstSimpleProductForFixed">
            <argument name="url">{$grabExportUrl}</argument>
            <argument name="expectedString">$$firstSimpleProductForFixed.sku$$</argument>
        </helper>
        <helper class="\Magento\Backend\Test\Mftf\Helper\CurlHelpers" method="assertCurlResponseContainsString" stepKey="assertDownloadFileContainsSecondSimpleProductForFixed">
            <argument name="url">{$grabExportUrl}</argument>
            <argument name="expectedString">$$secondSimpleProductForFixed.sku$$</argument>
        </helper>
        <helper class="\Magento\Backend\Test\Mftf\Helper\CurlHelpers" method="assertCurlResponseContainsString" stepKey="assertDownloadFileContainsFixedBundleProduct">
            <argument name="url">{$grabExportUrl}</argument>
            <argument name="expectedString">$$createFixedBundleProduct.sku$$</argument>
        </helper>
        <helper class="\Magento\Backend\Test\Mftf\Helper\CurlHelpers" method="assertCurlResponseContainsString" stepKey="assertDownloadFileContainsFirstSimpleProductForFixedWithAttribute">
            <argument name="url">{$grabExportUrl}</argument>
            <argument name="expectedString">$$firstSimpleProductForFixedWithAttribute.sku$$</argument>
        </helper>
        <helper class="\Magento\Backend\Test\Mftf\Helper\CurlHelpers" method="assertCurlResponseContainsString" stepKey="assertDownloadFileContainsSecondSimpleProductForFixedWithAttribute">
            <argument name="url">{$grabExportUrl}</argument>
            <argument name="expectedString">$$secondSimpleProductForFixedWithAttribute.sku$$</argument>
        </helper>
        <helper class="\Magento\Backend\Test\Mftf\Helper\CurlHelpers" method="assertCurlResponseContainsString" stepKey="assertDownloadFileContainsFixedBundleProductWithAttribute">
            <argument name="url">{$grabExportUrl}</argument>
            <argument name="expectedString">$$createFixedBundleProductWithAttribute.sku$$</argument>
        </helper>

        <!-- Delete Export File -->
        <actionGroup ref="DeleteExportedFileActionGroup" stepKey="deleteExportedFile">
            <argument name="fileName" value="{$grabNameFile}"/>
        </actionGroup>
        <helper class="\Magento\Catalog\Test\Mftf\Helper\LocalFileAssertions" method="assertFileDoesNotExist" stepKey="assertExportFileDeleted">
            <argument name="filePath">var/export/{$grabNameFile}</argument>
        </helper>
    </test>
</tests>
