<?xml version="1.0" encoding="UTF-8"?>
<!--
 /**
  * Copyright Â© Magento, Inc. All rights reserved.
  * See COPYING.txt for license details.
  */
-->

<tests xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:noNamespaceSchemaLocation="urn:magento:mftf:Test/etc/testSchema.xsd">
    <test name="AdminExportTaxRatesTest">
        <annotations>
            <features value="TaxImportExport"/>
            <stories value="Export"/>
            <title value="Export Tax Rates"/>
            <description value="Exports tax rates from the System > Data Transfer > Import/Export Tax Rates page and
            validates contents in downloaded file. Note that MFTF cannot simply click export and have access to the file
            that is downloaded in the browser due to the test not having access to the server that is running the test
            browser. Therefore, this test clicks the Export button, grabs the request URI from the browser, and executes
            the same request on the magento machine via a curl request to download the same file there so that the test
            has access to the exported file."/>
            <severity value="MAJOR"/>
            <testCaseId value="MC-38949"/>
            <group value="importExport"/>
            <group value="tax"/>
        </annotations>

        <before>
            <!-- Create/Revert Seed Data -->
            <createData entity="US_CA_Rate_1" stepKey="revertInitialTaxRateCA"/>
            <createData entity="US_NY_Rate_1" stepKey="revertInitialTaxRateNY"/>

            <!-- Login as Admin -->
            <actionGroup ref="AdminLoginActionGroup" stepKey="loginAsAdmin"/>
        </before>

        <after>
            <!-- Logout -->
            <actionGroup ref="AdminLogoutActionGroup" stepKey="logoutFromAdmin"/>
        </after>

        <!-- Export Tax Rates & Validate Export -->
        <actionGroup ref="AdminNavigateImportExportTaxRatesActionGroup" stepKey="navigateToImportExportTaxRatesPage"/>
        <actionGroup ref="AdminExportTaxRatesActionGroup" stepKey="exportTaxRates"/>
        <executeJS function="return window.performance.getEntriesByName('mousedown')[0].target.baseURI" stepKey="exportURI"/>
        <comment userInput="{$exportURI}" stepKey="commentExportURI"/>
        <executeJS function="return window.location.origin" stepKey="baseUrl"/>
        <helper class="\Magento\TaxImportExport\Test\Mftf\Helper\CurlHelpers" method="assertCurlResponseContainsString" stepKey="assertExportedFileContainsCATaxRate">
            <argument name="uri">{$baseUrl}/admin/tax/rate/exportPost/</argument>
            <argument name="expectedString">{{US_CA_Rate_1.code}}</argument>
        </helper>
        <helper class="\Magento\TaxImportExport\Test\Mftf\Helper\CurlHelpers" method="assertCurlResponseContainsString" stepKey="assertExportedFileContainsNYTaxRate">
            <argument name="uri">{$baseUrl}/admin/tax/rate/exportPost/</argument>
            <argument name="expectedString">{{US_NY_Rate_1.code}}</argument>
        </helper>
    </test>
</tests>
